# Use the existing image as the base
FROM --platform=linux/arm64 khsydney/spring-petclinic-customers-service:latest
WORKDIR /application
COPY ./appagent /opt/appdynamics/
EXPOSE 8081
# Set arguments for AppDynamics agent configuration
ARG APPDYNAMICS_AGENT_APPLICATION_NAME
ARG APPDYNAMICS_AGENT_TIER_NAME
ARG APPDYNAMICS_AGENT_NODE_NAME
ARG APPDYNAMICS_AGENT_ACCOUNT_NAME
ARG APPDYNAMICS_AGENT_ACCOUNT_ACCESS_KEY
ARG APPDYNAMICS_CONTROLLER_HOST_NAME
ARG APPDYNAMICS_CONTROLLER_PORT
ARG APPDYNAMICS_CONTROLLER_SSL_ENABLED

# Set environment variables for AppDynamics agent configuration
ENV APPDYNAMICS_AGENT_APPLICATION_NAME=${APPDYNAMICS_AGENT_APPLICATION_NAME}
ENV APPDYNAMICS_AGENT_TIER_NAME=${APPDYNAMICS_AGENT_TIER_NAME}
ENV APPDYNAMICS_AGENT_NODE_NAME=${APPDYNAMICS_AGENT_NODE_NAME}
ENV APPDYNAMICS_AGENT_ACCOUNT_NAME=${APPDYNAMICS_AGENT_ACCOUNT_NAME}
ENV APPDYNAMICS_AGENT_ACCOUNT_ACCESS_KEY=${APPDYNAMICS_AGENT_ACCOUNT_ACCESS_KEY}
ENV APPDYNAMICS_CONTROLLER_HOST_NAME=${APPDYNAMICS_CONTROLLER_HOST_NAME}
ENV APPDYNAMICS_CONTROLLER_PORT=${APPDYNAMICS_CONTROLLER_PORT}
ENV APPDYNAMICS_CONTROLLER_SSL_ENABLED=${APPDYNAMICS_CONTROLLER_SSL_ENABLED}

# ENTRYPOINT ["java","-jar","/app.jar"]
ENTRYPOINT ["java","-javaagent:/opt/appdynamics/javaagent.jar", "-Dappdynamics.agent.logs.dir=/app/logs/","org.springframework.boot.loader.launch.JarLauncher"]